---
title: 析合树学习笔记
tags:
  - ds
  - trees
---

做题做到了，发现大纲里没有，怕某些阴间人当线段树出出来，随便学学。

可能不是很严谨，姑且看看吧。

~~感觉在复读 [oi-wiki](https://oi-wiki.org/ds/divide-combine/) 和 [这个神仙的博客](https://taodaling.github.io/blog/2020/08/11/%E6%9E%90%E5%90%88%E6%A0%91/)~~

## 1 一些定义
### 1.1 连续段
对于一个排列 $P$，我们定义它上面的一个区间 $(P, [l, r])$ 为一个 **“连续段”**，当且仅当它满足 $P\_l \sim P\_r$ 在值域上是连续的。

或者说对 $P\_l \sim P\_r$ 中的元素排序后，$\max - \min = r - l$。

我们发现，对于两个连续段 $A, B$，其 **交、并、差** 都是连续段，证明略，可以自行感性理解一下。

### 1.2 本原段
我们按照上面连续段的定义，不难发现一个排列的连续段数量可以达到 $\mathcal{O}(n^2)$ 级别，难以形成一个优秀的数据结构。

因此我们考虑选取一些具有代表性的连续段，于是我们引入了 **“本原段”** 的概念。

我们一个连续段是一个 **“本原段”**（或者叫本原连续段），当且仅当不存在另外一个连续段与其 **部分相交**。

根据其定义，我们不难发现两个本原段只可能是 **相离或包含** 的关系。

## 2 一些基本信息
### 2.1 析合树结构
我们考虑把所有本原段建成一个和线段树类似的树形结构，称为 **“析合树”**，每一个本原段对应结点的所有儿子结点的集合就是构成它的所有 **极大本原段** 对应结点的集合。

因此不难发现，一个非叶子结点至少有两个儿子，因此结点个数的上界是 $2n-1$。

考虑每一个本原段对应一个值域上的区间，我们定义一个结点的 **值域区间** 为它对应的这个区间。

然后对于一个非叶子结点，我们把它所有的儿子按原序列上的顺序加到一个序列中，称之为这个结点的 **“儿子序列”**。

再把 “儿子序列” 按 “值域区间左端点从小到大” 离散化，得到一个排列，我们称它为这个结点的 **儿子排列”**。

然后我们终于可以引入 “析合” 的概念了，我们把所有点分为两类：
+ 合点：这个结点的儿子排列单调（递增或递减），特殊的，一个叶子结点也是一个合点。
+ 析点：若一个点不是合点就是析点。

下面这幅 oi-wiki 上的图片应该可以很直观地阐释一个析合树的结构：
![](https://oi-wiki.org/ds/images/div-com1.png)

### 2.2 一些性质
析点和合点这么命名显然是有性质的：
+ 合点：儿子序列中的每一个严格子区间都是一个连续段。
+ 析点：儿子序列中的每一个长度大于 $1$ 的严格子区间都不是一个连续段。

合点的性质很显然，析点这个就有点难以理解了。

我们可以考虑这个结点儿子序列中的每一个长度大于 $1$ 的严格子区间，若其中存在一个连续段，那么必有另一个与其相交的严格子区间也是一个连续段，否则它会成为一个本原连续段而违反了定义。

而这样归纳证明下去，会导致这个结点儿子序列中每一个长度大于 $1$ 的严格子区间都形成一个连续段，这会使它成为一个合点。

因此儿子序列中的每一个长度大于 $1$ 的严格子区间都不是一个连续段。

也因此，一个析点至少有 $4$ 个儿子（两个或三个都会合并）。

而且很显然，一个连续段要么就是析合树上的一个结点，此时它是一个本原段；要么可以被某个结点的儿子序列表示出来，而不是像线段树一样由多个结点表示，这个考虑本原段和连续段的性质就行了，详细证明略。

## 3 析合树的构造
### 3.1 增量法
顾名思义，我们假设我们已经构造出了一个原序列中前 $k-1$ 个元素的析合森林，

