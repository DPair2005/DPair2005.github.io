<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <link rel="stylesheet" type="text/css" href="/css/art.css">
    <link rel="icon" type="images/png" href="/images/favicon.png">
    <script src="/js/header.js"></script>
<script src="/js/search.js"></script>
<script src="/js/theme.js"></script>
<script src="/js/hitokoto.js"></script>

    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.2.0/build/styles/atom-one-light.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.2.0/build/highlight.min.js"></script>
    <script src="/js/language.min.js"></script>
    <title>
        记录一个线段树合并的 trick - DPairの非自制 blog
    </title>
</head>

<body>
        <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/load_theme.js"></script>

    <script>
        window.onload = function() {
            loadMath();
            drawSaying();
            hljs.configure({ tabReplace: '    ' });
            hljs.highlightAll()
        }
    </script>

    <div class="content">
        <div class="sidebar" id="sidebar">
            <script>
    document.heartland = false;
    window.localStorage.setItem('heartland', false);
</script>

<div class="sidebar-title">
    <p style="font-weight: bold; font-size: 25px; font-family: 'ZCOOL XiaoWei';" onclick="drawSaying()"> 
    DPairの非自制 blog
    </p>
    <hr align="center" style="width: 200px;">
    <p></p>
    <div font style="text-align: center; font-size: 18px; font-family: 'ZCOOL XiaoWei';" class="sayingtype" id="sayingtype"> </div>
    <div font="" style="text-align: center; font-size: 6px;"> 　 </div>
    <div class="saying" id="saying"> </div>
</div>


<div class="sidebar-body">

    <div class="sidebar-content">
        <ul class="sidebar-menu">
            <a href="/">
                <li class="list-item sidebar-menu-item" id="sidebar-content-home">
                    Home
                </li>
            </a>
            <a href="/articles">
                <li class="list-item sidebar-menu-item" id="sidebar-content-articles" style="background: #e5e5e5">
                    Articles
                </li>
            </a>
            <a href="/tags">
                <li class="list-item sidebar-menu-item" id="sidebar-content-tags">
                    Tags
                </li>
            </a>
        </ul>
    </div>

    <div class="sidebar-about">
    <div style="text-align: center; font-size: 16px;">
        <a href="/aboutme" style="text-decoration: none; color: currentColor;">
            About me
        </a>
    </div>
    <HR align="center">
    <div class="avatar-rotate" style="margin: 2 auto; width: min-content">
        <img class="avatar" alt="DPair" src="/images/avatar.png", onclick="NextBackground()">
    </div>

    <ul class="sidebar-links">
    <li class="sidebar-links-item">
        <a href="https://dpair2005.github.io" class="friend-link">
            github blog 
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://dpair.gitee.io" class="friend-link">
            gitee blog 
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://www.luogu.com.cn/blog/DPair2005/" class="friend-link">
            luogu blog 
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://codeforces.com/profile/DPair" class="friend-link">
            Codeforces 
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://atcoder.jp/users/DPair" class="friend-link">
            AtCoder 
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://github.com/DPair2005" class="friend-link">
            github 
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://gitee.com/DPair" class="friend-link">
            gitee 
        </a>
    </li>
    </ul>

</div>

<ul class="sidebar-links">
    <div style="text-align: center; font-size: 16px;"> links </div>
    <HR align="center">

    <li class="sidebar-links-item">
        <a href="https://coderoj.gitee.io/" class="friend-link">
            Jacder's blog
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://xyix.github.io/" class="friend-link">
            xYix's blog
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://www.cnblogs.com/flying2018" class="friend-link">
            flying2018's blog
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://www.cnblogs.com/Point-King/" class="friend-link">
            Point_King's blog
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://cnblogs.com/pealfrog" class="friend-link">
            xtw's blog
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="http://xyf007.ml/" class="friend-link">
            xyf007's blog
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://www.cnblogs.com/zkdxl" class="friend-link">
            zkdxl's blog
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://www.cnblogs.com/guts" class="friend-link">
            krimson's blog
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://blog.moonpie.cf/" class="friend-link">
            moonpie's blog
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://www.luogu.com.cn/blog/wh2005blog/" class="friend-link">
            wuhao2005's blog
        </a>
    </li>
<li class="sidebar-links-item">
        <a href="https://blog.jasonfan.ml/" class="friend-link">
            jasonfan's blog
        </a>
    </li>

</ul>



</div>
        </div>

        <div class="post" id="post">
            <h1>记录一个线段树合并的 trick</h1>
            <p>感谢 LMOliver 友情赠送的证明。</p>
<p>可以解决这样的问题：</p>
<p><strong>给你一棵树，每一个节点对应一个区间修改和一个区间询问的操作，一个点的答案即为其子树内所有区间修改被执行后进行区间询问的结果</strong></p>
<p>不难发现可以扩展到同一个点多个修改和多个询问的情况，这里不赘述。</p>
<p>首先众所周知我们朴素的线段树合并空间是 $\mathcal{O}(n\log n)$ 的。</p>
<p>然后一般不可持久化的线段树合并为了减小空间常数都会选择垃圾回收，就是无用节点进一个回收栈给后面的节点留空间。</p>
<p>但是这样子的话并没有优化空间复杂度，仍然会被形如毛毛虫的数据卡掉。</p>
<p>大概就是这样：</p>
<p><img src="./graph.png" alt=""></p>
<p>我们只要先遍历编号大的节点再遍历编号小的节点就挂了，因为我们优先遍历子树大小小的子树导致了节点存储的信息都是 $\mathcal{O}(\log n)$ 级别，而这样的节点个数是 $\mathcal{O}(n)$ 级别的。</p>
<p>但是我们注意到先小后大就不会挂，因此考虑遍历子树大小更大的子树。</p>
<p>于是我们想到重剖，然后每一次先走子树大小最大的那一个儿子，不难发现遍历第一个儿子时当前节点是不存信息的。</p>
<p>说明只有经过轻边才会存储信息，显然这样的点是 $\mathcal{O}(\log n)$ 个。</p>
<p>那么这里上界已经证明到 $\mathcal{O}(n\log n)$ 了，我们注意到这个上界还大有可以收缩的可能性。</p>
<p>考虑这 $\mathcal{O}(\log n)$ 个经过轻边的子树的大小，由于重剖的性质应该上界是 $n, \frac{n}{2}, \frac{n}{4}, \cdots, \frac{n}{2^k}, \cdots, 1$。</p>
<p>我们可以认为子树内的所有修改都直接修改在对应的根上，因此考虑分析一棵经过了 $x$ 次区间修改的动态开点线段树到底会开多少点。</p>
<p>由于每一层被修改的点数最多是 $2x$，与原本每一层的点数取 $\min$ 后，发现前 $\log x$ 层和后 $\log n - \log x$ 层分别是 $2^i, x$ 个点。其中 $i$ 表示层数。</p>
<p>那么前 $\log x$ 层的节点个数和是 $\mathcal{O}(x)$ 这个应该没什么问题，不难发现这个求和之后是 $\mathcal{O}(n)$。</p>
<p>那么现在只需要证明后 $\log n - \log x$ 层的节点个数和也是 $\mathcal{O}(n)$。</p>
<p>相当于求一个这个级别的式子：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\sum_{i=0}^{\log n} i\frac{n}{2^i} &\le \sum_{i=0}^{\infty} i\frac{n}{2^i} \\
&=2n
\end{aligned}</script><p>所以是 $\mathcal{O}(n)$ 的。</p>
<p>世界名画：《 $\mathcal{O}(n)$ 空 间 线 段 树 合 并 》</p>

            

        </div>

    </div>
</body>