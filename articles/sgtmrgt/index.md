---
title: 记录一个线段树合并的 trick
tags:
  - ds
  - tricks
  - trees
---
首先众所周知我们朴素的线段树合并空间是 $\mathcal{O}(n\log n)$ 的。

然后一般不可持久化的线段树合并为了减小空间常数都会选择垃圾回收，就是无用节点进一个回收栈给后面的节点留空间。

但是这样子的话并没有优化空间复杂度，仍然会被形如毛毛虫的数据卡掉。

大概就是这样：

![](./graph.png)

我们只要先遍历编号大的节点再遍历编号小的节点就挂了。

但是我们注意到先大后小就不会挂。

于是我们想到重剖，然后每一次先走子树大小最大的那一个儿子。

据说空间复杂度是 $\mathcal{O}(n)$ 的，但是我不会证（（

不过其他剖应该还是错的。